<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Adventure Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f0f0f0;
        }
        #game-container {
            display: flex;
            flex-grow: 1;
            gap: 20px;
        }
        #text-pane {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #graphics-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #game-canvas {
            width: 100%;
            height: 300px;
            background-color: #e0e0e0;
            border-radius: 5px;
        }
        #input-area {
            margin-top: 20px;
            display: flex;
        }
        #user-input {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px 0 0 5px;
        }
        #submit-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }
        #submit-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Text Adventure Game</h1>
    <div id="game-container">
        <div id="text-pane"></div>
        <div id="graphics-pane">
            <canvas id="game-canvas"></canvas>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="Enter your command...">
                <button id="submit-button">Submit</button>
            </div>
        </div>
    </div>

    <script src="./ollama-api-wrapper.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            class Item {
                constructor(nickname, shortDescription, longDescriptionPrompt, attributes) {
                    this.nickname = nickname;
                    this.shortDescription = shortDescription;
                    this.longDescriptionPrompt = longDescriptionPrompt;
                    this.attributes = attributes;
                }
            }

            class Room {
                constructor(shortDescription, longDescriptionPrompt, items) {
                    this.shortDescription = shortDescription;
                    this.longDescriptionPrompt = longDescriptionPrompt;
                    this.items = items;
                    this.connections = {};
                }
            }

            class GameState {
                constructor(config) {
                    this.gameName = config.game_name;
                    this.initialState = config.initial_state;
                    this.items = Object.fromEntries(
                        config.items.map(item => [item.nickname, new Item(item.nickname, item.short_description, item.long_description_prompt, item.attributes)])
                    );
                    this.rooms = Object.fromEntries(
                        config.rooms.map(room => [room.id, new Room(room.short_description, room.long_description_prompt, room.items)])
                    );
                    this.playerInventory = new Room("Inventory", "Your personal inventory", []);
                    this.currentRoom = this.rooms[config.starting_room];
                }

                move(direction) {
                    if (this.currentRoom.connections[direction]) {
                        this.currentRoom = this.rooms[this.currentRoom.connections[direction]];
                        return true;
                    }
                    return false;
                }

                takeItem(itemNickname) {
                    const index = this.currentRoom.items.indexOf(itemNickname);
                    if (index !== -1) {
                        this.currentRoom.items.splice(index, 1);
                        this.playerInventory.items.push(itemNickname);
                        return true;
                    }
                    return false;
                }

                dropItem(itemNickname) {
                    const index = this.playerInventory.items.indexOf(itemNickname);
                    if (index !== -1) {
                        this.playerInventory.items.splice(index, 1);
                        this.currentRoom.items.push(itemNickname);
                        return true;
                    }
                    return false;
                }
            }

            class GameEngine {
                constructor(config) {
                    this.gameState = new GameState(config);
                    this.textPane = document.getElementById('text-pane');
                    this.canvas = document.getElementById('game-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.userInput = document.getElementById('user-input');
                    this.submitButton = document.getElementById('submit-button');

                    this.submitButton.addEventListener('click', () => this.handleUserInput());
                    this.userInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.handleUserInput();
                        }
                    });

                    this.directionAliases = {
                        'n': 'north', 's': 'south', 'e': 'east', 'w': 'west',
                        'nw': 'northwest', 'sw': 'southwest', 'se': 'southeast', 'ne': 'northeast',
                        'u': 'up', 'd': 'down', 'in': 'inside', 'out': 'outside'
                    };
                    this.ollama = new OllamaApiWrapper('llama3:latest');
                }

                async parseCommand(userInput) {
                    const parts = userInput.toLowerCase().trim().split(/\s+/);
                    let command = parts[0];
                    let parameters = parts.slice(1);

                    // Handle direction aliases
                    if (this.directionAliases[command]) {
                        parameters = [this.directionAliases[command]];
                        command = 'go';
                    }

                    // Handle other aliases
                    if (command === 'l') command = 'look';
                    if (command === 'x') command = 'examine';

                    // Handle implicit 'go' command
                    if (Object.values(this.directionAliases).includes(command)) {
                        parameters = [command];
                        command = 'go';
                    }

                    return { command, parameters };
                }

                async executeCommand(command, parameters) {
                    switch (command) {
                        case "go":
                            return this.gameState.move(parameters[0])
                                ? `You move ${parameters[0]}.`
                                : `You can't go ${parameters[0]}.`;
                        case "take":
                            return this.gameState.takeItem(parameters[0])
                                ? `You take the ${parameters[0]}.`
                                : `You can't take the ${parameters[0]}.`;
                        case "drop":
                            return this.gameState.dropItem(parameters[0])
                                ? `You drop the ${parameters[0]}.`
                                : `You can't drop the ${parameters[0]}.`;
                        case "look":
                            return this.look();
                        case "examine":
                            return this.examine(parameters[0]);
                        case "inventory":
                            return `You are carrying: ${this.gameState.playerInventory.items.join(', ')}`;
                        default:
                            return "I don't understand that command.";
                    }
                }

                async look() {
                    const longDescription = await this.generateSceneDescription();
                    const itemDescriptions = this.gameState.currentRoom.items.map(item => 
                        `${item}: ${this.gameState.items[item].shortDescription}`
                    ).join(', ');
                    return `${longDescription}\n\nYou can see: ${itemDescriptions}`;
                }

                async generateItemDescription(item) {
                    if (item) {
                        return await this.ollama.generateResponse(item.longDescriptionPrompt);
                    }
                    return `You don't see any such thing here.`;
                }

                async examine(itemName) {
                    const item = this.gameState.items[itemName];
                    if (item && (this.gameState.currentRoom.items.includes(itemName) || this.gameState.playerInventory.items.includes(itemName))) {
                        console.log('Generating item description...');
                        return this.generateItemDescription(item);
                    }
                    return `You don't see any ${itemName} here.`;
                }

                async generateSceneDescription() {
                    const prompt = `Describe the following scene in detail: ${this.gameState.currentRoom.longDescriptionPrompt}`;
                    try {
                        return await this.ollama.generateResponse(prompt);
                    } catch (error) {
                        console.error('Error generating scene description:', error);
                        return this.gameState.currentRoom.shortDescription;
                    }
                }

                generateSceneGraphic() {
                    // This method would generate a wire frame "3D" view of the current scene
                    this.ctx.fillStyle = 'white';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.strokeStyle = 'black';
                    this.ctx.beginPath();
                    this.ctx.moveTo(50, 50);
                    this.ctx.lineTo(200, 50);
                    this.ctx.lineTo(200, 200);
                    this.ctx.lineTo(50, 200);
                    this.ctx.closePath();
                    this.ctx.stroke();
                }

                appendToTextPane(text) {
                    const p = document.createElement('p');
                    p.textContent = text;
                    this.textPane.appendChild(p);
                    this.textPane.scrollTop = this.textPane.scrollHeight;
                }

                async handleUserInput() {
                    const userInput = this.userInput.value;
                    this.userInput.value = '';
                    this.appendToTextPane(`> ${userInput}`);

                    const { command, parameters } = await this.parseCommand(userInput);
                    const result = await this.executeCommand(command, parameters);
                    this.appendToTextPane(result);

                    if (command === 'go' || command === 'look') {
                        this.generateSceneGraphic();
                    }
                }

                start() {
                    this.appendToTextPane(`Welcome to ${this.gameState.gameName}!`);
                    this.appendToTextPane(this.gameState.currentRoom.shortDescription);
                    this.generateSceneGraphic();
                }
            }

            // Sample configuration (replace with actual game configuration)
            const gameConfig = {
                game_name: "Enhanced Adventure",
                initial_state: {},
                starting_room: "start",
                items: [
                    { nickname: "key", short_description: "A rusty key", long_description_prompt: "An old, rusty key that might unlock something.", attributes: {} },
                    { nickname: "book", short_description: "A dusty book", long_description_prompt: "A thick, leather-bound book covered in dust.", attributes: {} }
                ],
                rooms: [
                    { 
                        id: "start", 
                        short_description: "a dimly lit room", 
                        long_description_prompt: "You find yourself in a small, dimly lit room with stone walls. There's a wooden door to the north.", 
                        items: ["key", "book"]
                    },
                    {
                        id: "corridor",
                        short_description: "a long corridor",
                        long_description_prompt: "You're in a long, narrow corridor. The walls are made of rough stone, and you can see flickering torchlight in the distance.",
                        items: []
                    }
                ]
            };

            // Add connections between rooms
            gameConfig.rooms[0].connections = { north: "corridor" };
            gameConfig.rooms[1].connections = { south: "start" };

            const game = new GameEngine(gameConfig);
            game.start();
        });
    </script>
</body>
</html>
