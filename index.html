<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Adventure Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #game-container {
            width: 80%;
            max-width: 600px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #text-pane {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;

            /* make text wrap and respect line breaks */
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #input-area {
            display: flex;
        }
        #user-input {
            flex-grow: 1;
            padding: 5px;
        }
        #submit-button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="text-pane"></div>
        <div id="input-area">
            <input type="text" id="user-input" autocomplete="off" placeholder="Enter your command...">
            <button id="submit-button">Submit</button>
        </div>
    </div>

    <script>
        // Ollama API wrapper functions
        async function generateItemDescription(item) {
            const prompt = `Briefly describe the item "${item}" briefly. The description should be in the second person, as if addressing the player directly. Keep it concise.`;
            return await generateOllamaResponse(prompt);
        }

        async function generateRoomDescription(room, room_name, prompt, item_names = []) {
            const fullPrompt = `Describe the following room briefly: "${room}". ${prompt} The description should be in the second person, as if addressing the player directly. Keep it concise.`;
            const response = await generateOllamaResponse(fullPrompt);
            let base_response = `<b>${room_name}</b>\n\n${response}`;
            let actual_response = base_response;
            if (item_names.length > 0) {
                actual_response = `${base_response}\n\nYou see: ${item_names.join(', ')} here.`;
            }
            return actual_response;
        }

        async function generateOllamaResponse(prompt) {
            const response = await fetch('http://localhost:11434/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'llama3:latest',
                    prompt: prompt,
                    max_tokens: 250,
                    temperature: 0.7,
                    stream: false
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.response;
        }

        // Game state
        let currentRoom = 'start';
        let illuminated = false;

        const inventory = [];

        // List of items
        const items = {
            key: {
                name: 'Rusty Key',
                promptDescription: 'An old, rusty key with intricate engravings. Use it to unlock something.',
            },
            book: {
                name: 'Mysterious Book',
                promptDescription: 'A leather-bound book with strange symbols on its cover. Only readable words are "Drink more ovaltine." in ancient script.',
            },
            lantern: {
                name: 'Antique Lantern',
                lit: false,
                promptDescription: 'A brass lantern that seems to still have some oil in it.',
            },
            rug: {
                name: 'Tattered Rug',
                promptDescription: 'A worn rug with faded patterns.',
            }
        };

        // Game rooms
        const rooms = {
            start: {
                name: 'Dimly Lit Room', // 'Start'
                promptDescription: "A dimly lit room with a musty smell. There's a door to the north and a window to the east.",
                exits: { north: 'hallway', east: 'garden' }
            },
            hallway: {
                name: 'Creepy Hallway',
                promptDescription: "A long hallway with creaky floorboards. There's a door to the south and a staircase leading up.",
                exits: { south: 'start', up: 'attic' },
                items: ['rug']
            },
            garden: {
                name: 'Overgrown Garden',
                promptDescription: "An overgrown garden with various plants and flowers. There's a shed to the north and you can go back west.",
                exits: { north: 'shed', west: 'start' },
                items: ['key']
            },
            shed: {
                name: 'Garden Shed',
                promptDescription: "A small, wooden shed filled with old gardening tools and cobwebs.",
                exits: { south: 'garden' },
                items: ['lantern']
            },
            attic: {
                name: 'Dusty Attic',
                promptDescription: "A dusty attic with slanted ceilings and a small, round window. There's a locked chest in the corner.",
                exits: { down: 'hallway' },
                locked: true,
                items: ['book']
            },
            basement: {
                name: 'Dark Basement',
                promptDescription: "A dark, damp basement with a musty smell. There's a flickering lightbulb overhead.",
                dark: true,
                exits: { up: 'hallway' }
            }
        };


        function getItemNames(roomObject){

            if (!roomObject.items ||
                roomObject.items.length == 0) {
                return [];
            }

            const itemNames = roomObject.items.map(item => items[item].name);
            return itemNames;
        }

        // Game personality
        const personality = "Use style: Dirk Gently's Holistic Detective Agency. Be concise."

        // Game commands
        const commands = {
            go: (direction) => {
                const exits = rooms[currentRoom].exits;
                if (exits[direction]) {
                    if (exits[direction] === 'attic' && rooms.attic.locked) {
                        return "The attic door is locked. You need a key to unlock it.";
                    }
                    currentRoom = exits[direction];
                    let base_prompt = rooms[currentRoom].promptDescription;
                    if (rooms[currentRoom].dark && !illuminated) {
                        base_prompt += " It's too dark to see anything.";
                    }
                    return generateRoomDescription(currentRoom, rooms[currentRoom].name, `Describe as if arriving as the scene is coming into view: ${rooms[currentRoom].promptDescription}. ${personality}`, getItemNames(rooms[currentRoom]));
                } else {
                    return "You can't go that way.";
                }
            },
            look: () => generateRoomDescription(currentRoom, rooms[currentRoom].name, `${rooms[currentRoom].promptDescription}. ${personality}`, getItemNames(rooms[currentRoom])),
            examine: async (itemName) => {
                const item = inventory.find(i => i.toLowerCase() === itemName.toLowerCase()) || 
                             (rooms[currentRoom].items && rooms[currentRoom].items.find(i => i.toLowerCase() === itemName.toLowerCase()));
                if (item) {
                    return generateItemDescription(`${items[item].name}. ${personality}`);
                } else {
                    return `There's no ${itemName} here to examine.`;
                }
            },
            take: (itemName) => {
                const roomItems = rooms[currentRoom].items;
                const item = roomItems && roomItems.find(i => i.toLowerCase() === itemName.toLowerCase());
                if (item) {
                    inventory.push(item);
                    rooms[currentRoom].items = roomItems.filter(i => i !== item);
                    return `You take the ${items[item].name}.`;
                } else {
                    return `There's no ${itemName} here to take.`;
                }
            },
            inventory: () => {
                if (inventory.length === 0) {
                    return "Your inventory is empty.";
                } else {
                    return `You are carrying: ${inventory.map(item => items[item].name).join(', ')}`;
                }
            },
            move: (object) => {
                if (object === 'rug' && currentRoom === 'hallway') {
                    rooms.hallway.exits.down = 'basement';
                    rooms.hallway.items = rooms.hallway.items.filter(i => i !== 'rug');
                    return "You lift the rug and find a trapdoor underneath.";
                } else {
                    return "You can't move that."
                }
            },
            use: (itemName) => {
                const item = inventory.find(i => i.toLowerCase() === itemName.toLowerCase());
                if (item === 'lantern') {

                    items.lantern.lit = !items.lantern.lit;
                    illuminated = items.lantern.lit;

                    return illuminated ? "The lantern casts a warm glow." : "You turn off the lantern.";
                }
                else
                if (item === 'key' && currentRoom === 'hallway') {
                    rooms.attic.locked = false;
                    return "You use the key to unlock the attic door.";
                }
                else {
                    return "You can't use that here.";
                }
            }
        };

        const DIRECTIONS = ['north', 'south', 
                            'east', 'west', 'up', 
                            'down', 'n', 's', 'e', 
                            'w', 'u', 'd'];

        const ALIASES = {
            "turn on": "use",
            "turn off": "use",
            "light": "use",
            "unlight": "use",
            "pick up": "take",
            "grab": "take",
            "get": "take",
            "steal": "take",
            "look at": "examine",
            "inspect": "examine",
            "read": "examine",
            "invent": "inventory",
        };

        const ABBREV = {
            n: 'north',
            s: 'south',
            e: 'east',
            w: 'west',
            u: 'up',
            d: 'down',
            l: 'look',
            i: 'inventory',
            x: 'examine',
            t: 'take',
            g: 'go',
        };

        // Game logic
        async function processCommand(unaliased) {
            input = unaliased.toLowerCase()
            for (const [alias, command] of Object.entries(ALIASES)) {
                input = input.replace(alias, command);
            }

            const [initial_command, ...initial_args] = input.toLowerCase().split(' ');

            let command, args;

            if (DIRECTIONS.includes(initial_command)) {
                command = 'go';
                args = [initial_command];
            } else if(initial_command == 'get') {
                command = 'take';
                args = initial_args;
            }
            else {
                command = initial_command;
                args = initial_args;
            }

            // check for abbreviations
            if (ABBREV[command]) {
                command = ABBREV[command];
            }
            // substitute abbreviations
            args = args.map(arg => ABBREV[arg] || arg);

            console.log(command, args);

            if (commands[command]) {
                const result = await commands[command](...args);
                return result;
            } else {
                return "I don't understand that command.";
            }
        }

        // UI elements
        const textPane = document.getElementById('text-pane');
        const userInput = document.getElementById('user-input');
        const submitButton = document.getElementById('submit-button');

        // Display text in the game
        function displayText(text) {
            textPane.innerHTML += `<p>${text}</p>`;
            textPane.scrollTop = textPane.scrollHeight;
        }

        // Handle user input
        async function handleInput() {
            const input = userInput.value.trim();
            if (input) {
                displayText(`> ${input}`);
                const response = await processCommand(input);
                displayText(response);
                userInput.value = '';
            }
        }

        // Event listeners
        submitButton.addEventListener('click', handleInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleInput();
            }
        });

        // Initialize the game
        (async function() {
            displayText("Welcome to the Text Adventure Game!");
            const initialDescription = await generateRoomDescription(currentRoom, rooms[currentRoom].name, `${rooms[currentRoom].promptDescription}. ${personality}`);
            displayText(initialDescription);
        })();
    </script>
</body>
</html>